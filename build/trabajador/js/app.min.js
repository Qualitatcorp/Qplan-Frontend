/*! qplan - v0.4.0 - 2017-06-19 - for Ruben Tejeda*/

"use strict";angular.module("trabajador",["ngRoute","ngAnimate","mgcrea.ngStrap","ApiRest","rut","toastr","filters","vjs.video","ngSanitize"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/trabajador/welcome.html"}).when("/login",{templateUrl:"views/trabajador/login.html",controller:"loginController"}).when("/antecendentes",{templateUrl:"views/trabajador/antecendentes.html",controller:"antecendentesController"}).when("/introduccion",{templateUrl:"views/trabajador/introduccion.html"}).when("/experiencia",{controller:"experienciaController",templateUrl:"views/trabajador/experiencia.html"}).when("/introduccion",{templateUrl:"views/trabajador/introduccion.html"}).when("/evaluacion",{templateUrl:"views/trabajador/evaluacion.html",controller:"evaluacionController",resolve:{evaluacion:["apiServices","trabajadorStorage",function(a,b){return a.model("perfil").expand("modteorica,pet,evateorica,preguntas,alternativas,recursos,rhs,sources,rho,options").get(b.q.ot.per_id)}]}}).when("/config",{templateUrl:"views/trabajador/config.html",controller:"configController"}).when("/psicologicoPca",{templateUrl:"views/trabajador/iframe.html",controller:"psicologicoPcaController"}).when("/termino",{templateUrl:"views/trabajador/termino.html",controller:"terminoController",resolve:{ficha:["apiServices","trabajadorStorage",function(a,b){return a.model("ficha").params({tra_id:b.q.id,ot_id:b.q.ot.id}).search()}]}}).when("/404",{template:"Error 404 :)"}).otherwise({redirectTo:"/404"})}]),angular.module("ApiRest",[]).factory("WebApiConfig",function(){return{REST:{host:"/api",auth:"authentication",token:"token",refresh:"refresh",version:"v1",client_id:"qplan-evaluacion",client_secret:"8GiPyTX5wk"},get hostUrl(){return[this.REST.host,this.REST.version].join("/")},get authenticationUrl(){return[this.REST.host,this.REST.auth,this.REST.token].join("/")},get refreshUrl(){return[this.REST.host,this.REST.auth,this.REST.refresh].join("/")},resourceUrl:function(a){return[this.REST.host,this.REST.version,a].join("/")}}}),angular.module("ApiRest").factory("sessionServices",[function(){return{set token(a){console.log("Se almaceno token : "+a),sessionStorage.eva_access_token=a},get token(){return console.log("Token valido por : "+this.timeOut.getMinutes()+" minutos"),this.expire?null:sessionStorage.eva_access_token},set refresh(a){console.log("Se almaceno refresh : "+a),sessionStorage.eva_access_refresh=a},get refresh(){return sessionStorage.eva_access_refresh},set expire_in(a){console.log("La sesion dura : "+a/60+" minutos."),sessionStorage.eva_expire_in=Date.now()+1e3*a},get expire(){return void 0===sessionStorage.eva_expire_in||Date.now()>Number(sessionStorage.eva_expire_in)},get timeOut(){return new Date(Number(sessionStorage.eva_expire_in)-Date.now())},logout:function(){delete sessionStorage.eva_access_token,delete sessionStorage.eva_access_refresh,delete sessionStorage.eva_expire_in,delete sessionStorage.eva_cliend_id}}}]),angular.module("ApiRest").service("apiServices",["WebApiConfig","$http","$httpParamSerializer","sessionServices",function(a,b,c,d){return{_base:null,_primaryKey:"id",_params:{},request:function(a){return _.compact([_.compact(a).join("/"),c(this._params)]).join("?")},get:function(c){return this.credential(),b.get(this.request([a.resourceUrl(this._base),c]))},getAll:function(){return this.get()},search:function(){return this.credential(),b.get(a.resourceUrl(this._base)+"/search?"+c(this._params))},save:function(c){return this.credential(),c[this._primaryKey]?b.put([a.resourceUrl(this._base),c[this._primaryKey]].join("/"),c):b.post(a.resourceUrl(this._base),c)},remove:function(c){return this.credential(),b.delete([a.resourceUrl(this._base),c].join("/"))},params:function(a){return this._params={},angular.extend(this._params,a),this},fields:function(a){return angular.extend(this._params,{fields:a}),this},expand:function(a){return this._params={},angular.extend(this._params,{expand:a}),this},sort:function(a){return angular.extend(this._params,{sort:a}),this},page:function(a){return angular.extend(this._params,{page:a}),this},perPage:function(a){return angular.extend(this._params,{"per-page":a}),this},model:function(a,b){return angular.extend(this,{_base:a,_primaryKey:b||this._primaryKey,_params:{}}),angular.copy(this)},credential:function(){d.expire?delete b.defaults.headers.common.Authorization:b.defaults.headers.common.Authorization="Bearer "+d.token}}}]),angular.module("ApiRest").service("trabajadorStorage",[function(){return{set q(a){sessionStorage.setItem("trabajador",JSON.stringify(a))},get q(){return JSON.parse(sessionStorage.getItem("trabajador"))}}}]),angular.module("ApiRest").factory("evaluacionStorage",["apiServices",function(a){var b=a.model("ficha"),c=a.model("fichateorico"),d=a.model("ficharespuesta"),e={respuesta:[]},f={},g=[],h=[],i=function(a,b){g=[],a.ficteoricas&&a.ficteoricas.forEach(function(a){c.remove(a.id)}),b.forEach(function(b){c.save({mod_id:b.id,fic_id:a.id}).then(function(a){g.push(a.data)})})};return{nuevaEvaluacion:function(a,c){b.expand("ficteoricas").get(a.id).then(function(d){if(d.data.proceso){var e=d.data.proceso.split(",");e.push("EN PROGRESO TEORICO"),a.proceso=e.join(",")}else a.proceso=["EN PROGRESO TEORICO"];b.save(d.data).then(function(a){f=a.data,i(d.data,c)}),a={respuesta:[]}},function(a){console.warn("q")})},addRespuesta:function(a,b,c){var f=this.getRespuesta(a);f?(f.idAlternativa=b,f.idModulo=c,f.creado=moment().format("YYYY-MM-DD HH:mm:ss")):e.respuesta.push({idPregunta:a,idAlternativa:b,idModulo:c,creado:moment().format("YYYY-MM-DD HH:mm:ss")});var g=_.findWhere(h,{idPregunta:a});if(g)g.alt_id=b,d.save(g).then(function(a){});else{var i=this.getModulo(c);console.log(i),d.save({pre_id:a,fict_id:i.id,alt_id:b,creado:moment().format("YYYY-MM-DD HH:mm:ss")}).then(function(b){b.data.idPregunta=a,h.push(b.data)})}},getModulo:function(a){return _.findWhere(g,{mod_id:a})},getRespuesta:function(a){return _.findWhere(e.respuesta,{idPregunta:a})},eliminarEvaluacion:function(){e=null,console.log("Evaluacion eliminada")},terminarEvaluacion:function(){return f.proceso="FINALIZADO TEORICO,EN PROGRESO PSICOLOGICO",b.save(f)},get count(){return e.respuesta.length}}}]),angular.module("ApiRest").service("authenticationServices",["WebApiConfig","$http","sessionServices",function(a,b,c){return{credential:function(c,d,e,f,g){var h={username:c,password:d,grant_type:g||"password",client_id:a.REST.client_id,client_secret:a.REST.client_secret,refresh:e||"false",identity:f||""};return b.post(a.authenticationUrl,h)},set identity(a){sessionStorage.setItem("identity",JSON.stringify(a.scope)),c.token=a.access_token},get identity(){sessionStorage.getItem("identity")},renovate:function(){if(c.refresh)return b.post(a.refreshUrl,{refresh:c.refresh});console.log("No se puede actualizar la session")}}}]),function(a,b){function c(a){return"string"==typeof a?a.replace(/[^0-9kK]+/g,"").toUpperCase():""}function d(a,b){if(!(a=c(a)))return b;if(a.length<=1)return a;for(var d=a.slice(-4,-1)+"-"+a.substr(a.length-1),e=4;e<a.length;e+=3)d=a.slice(-3-e,-e)+"."+d;return d}function e(a){if("string"!=typeof a)return!1;for(var b=parseInt(a.slice(0,-1),10),c=0,d=1;b>0;)d=(d+b%10*(9-c++%6))%11,b=Math.floor(b/10);return(d>0?d-1+"":"K")===a.slice(-1)}function f(a){var b=function(b){var c=!(b.length>0)||e(b);return a.$setValidity("rut",c),c},f=function(a){return a=c(a),b(a)?a:null},g=function(a){return a=c(a),b(a),d(a)};a.$parsers.unshift(f),a.$formatters.unshift(g)}function g(a,b){a.$watch(function(){return b.$viewValue},function(){b.$setViewValue(d(b.$viewValue)),b.$render()})}function h(a,b){a.on("blur",function(){b.$setViewValue(d(b.$viewValue)),b.$render()})}a.module("rut",[]).directive("ngRut",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){switch(void 0===c.rutFormat&&(c.rutFormat="live"),f(d),c.rutFormat){case"live":g(a,d);break;case"blur":h(b,d)}}}}).filter("rut",function(){return d}).constant("RutHelper",{format:d,clean:c,validate:function(a){return e(c(a))}})}(angular),angular.module("trabajador").controller("terminoController",["$scope","ficha","trabajadorStorage","$sce","$location","$timeout","toastr",function(a,b,c,d,e,f,g){a.ficha=b.data[0],a.url=d.trustAsResourceUrl("http://tma.timshr.com/pca/f9e91068-912c-4303-82a3-5ae344332622/8"),a.changeIt=function(){a.url=d.trustAsResourceUrl("https://docs.angularjs.org/tutorial")},a.trabajador=c.q,console.log(a.trabajador)}]),angular.module("trabajador").controller("psicologicoPcaController",["$scope","$sce","$location","$timeout","toastr",function(a,b,c,d,e){a.url=b.trustAsResourceUrl("https://timshr.com/pruebapca//default.aspx?codigo=276bb6d9-a531-46cc-b851-db7fa6567c44&correo=&lang=es-cl&pS=0&inv=1&uD=0&iFrm=1")}]),angular.module("trabajador").controller("loginController",["$scope","$location","trabajadorStorage","apiServices","RutHelper","toastr","sessionServices","authenticationServices","$filter",function(a,b,c,d,e,f,g,h,i){var j=function(a){var b=document.getElementById("player");b.src=a,b.play()};j(i("dinamicSource")("src/audio/trabajador/AUTH.mp3"));var k=d.model("trabajador");a.login=function(){k.params({rut:e.format(a.rut)}).search().then(function(a){k.expand("ot,experiencias").get(a.data[0].id).then(function(a){a.data.ot?(c.q=a.data,b.path("antecendentes")):(j("src/audio/trabajador/AUTH_ERROR1.mp3"),f.warning("Usted no esta registrado en una orden de trabajo,solicite ayuda su instructor.","Atención"))})},function(a){switch(a.status){case 404:j("src/audio/trabajador/AUTH_ERROR2.mp3"),f.error("Usted no se encuentra registrado en el sistema, por favor solicite ayuda su instructor.","Atención")}console.warn(a)})}}]),angular.module("trabajador").controller("experienciaController",["$filter","trabajadorStorage","$modal","$scope","$location","apiServices","toastr","$timeout",function(a,b,c,d,e,f,g,h){function i(){j(a("dinamicSource")("src/audio/trabajador/EXP_NEXT.mp3")),setTimeout(function(){e.path("evaluacion")},3500)}console.log(b);var j=function(a){var b=document.getElementById("player");b.src=a,b.play()};j(a("dinamicSource")("src/audio/trabajador/EXP.mp3")),d.rubros=["Rubro Minero","Rubro Forestal","Rubro Energía","Rubro Petroleo","Rubro Metal-Mecánico","Rubro Telecomunicaciones"];var k=f.model("trabajadorexperiencia"),l=b.q,m=l.id;d.select={numbers:[0,1,2,3,4,5,6,7,8,9]},d.inputs=_.map(l.experiencias,function(a){return a.meses=parseInt(a.meses),a});var n=_.countBy(l.experiencias,function(a){return a.tipo});console.log(n),d.faenas=0|n.FAENA,d.proyectos=0|n.PROYECTO,d.estables=0|n.ESTABLE,d.tooltipfaena={title:"Hola, debes seleccionar la cantidad de experiencias en faenas que has hecho",checked:!1},d.tooltipestable={title:"Hola, debes seleccionar la cantidad de experiencias en servicios estables que has hecho",checked:!1},d.tooltipproyecto={title:"Hola, debes seleccionar la cantidad de experiencias en proyecto que has hecho",checked:!1},d.addInputs=function(a,b){var c=d.inputs.filter(function(a){return a.tipo===b}),e=a,f=c.length,g=e-f;if(g>=0)for(var h=1;h<=g;h++){d.inputs.length;d.inputs.push({tipo:b,tra_id:m})}else if(g<0)for(var i=-1*g,h=d.inputs.length-1;h>=0;h--)d.inputs[h].tipo==b&&i>0&&(d.inputs.splice(h,1),i--)},d.guardar=function(){var b=d.inputs.length,c=1;d.inputs.forEach(function(a){k.save(a).then(function(a){console.log(a),c++})}),(c=b)?(i(),g.success("Experiencia agregada exitosamente.","Atencion!")):(j(a("dinamicSource")("src/audio/trabajador/EXP_ERROR.mp3")),g.warning("Para poder continuar debe ingresar al menos una experiencia laboral.","Atención"))}}]),angular.module("trabajador").controller("evaluacionController",["$filter","$scope","evaluacionStorage","$location","evaluacion","trabajadorStorage","toastr",function(a,b,c,d,e,f,g){console.log(l);var h,i=document.getElementById("player"),j=document.getElementById("error"),k=function(a){a?i.src=i.src:i.load(),i.play()};b.repeat=function(){k()};var l=e.data,m=_.sample(_.uniq(_.pluck(l.preguntas,"tipo")));console.log("Evaluacion "+m);var n={};n.perfil=l.nombre,n.preguntas=[];var o=_.where(l.preguntas,{tipo:m});o.forEach(function(a){angular.extend(a,{alternativas:_.where(l.alternativas,{pre_id:a.id}),get recursos(){var b=_.findWhere(l.recursos,{pre_id:a.id});return angular.extend(b,{sources:_.map(_.where(l.rhs,{rec_id:b.id}),function(a){return _.findWhere(l.sources,{id:a.src_id})}),options:_.map(_.where(l.rho,{opt_id:b.id}),function(a){return _.findWhere(l.options,{id:a.src_id})})}),b},modulo:_.findWhere(l.modteorica,{id:_.findWhere(l.pet,{evt_id:_.findWhere(l.evateorica,{id:a.eva_id}).id}).mop_id})})}),c.nuevaEvaluacion(f.q.ficha,l.modteorica),b.evaluacion={perfil:l.nombre,preguntas:o},b.ficha={_current:0,get current(){return this._current},set current(c){c>=0&&c<this.preguntas.length&&(this._current=c,0==this._current?b.buttons.Anterior.disable=!0:(b.buttons.Anterior.disable=!1,this._current==this.preguntas.length-1?b.buttons.Siguiente.disable=!0:b.buttons.Siguiente.disable=!1)),setTimeout(function(){b.ficha.audioPregunta?(h=b.ficha.audioPregunta.src,i.src=a("dinamicSource")(b.ficha.audioPregunta.src),i.play()):i.pause()},1e3)},get progreso(){return c.count/this.preguntas.length},get respuesta(){return c.getRespuesta(this.pregunta.id)?c.getRespuesta(this.pregunta.id).idAlternativa:void 0},set respuesta(a){c.addRespuesta(this.pregunta.id,a,this.pregunta.modulo.id),1==this.progreso&&(b.buttons.Terminar.disable=!1)},get preguntas(){return b.evaluacion.preguntas},get pregunta(){return this.preguntas[this.current]},get recurso(){return this.pregunta.recursos},video:{get options(){return b.ficha.recurso.option},media:{get sources(){return b.ficha.recurso.sources}}},audio:{get options(){return b.ficha.recurso.option.poster=this.poster.src,b.ficha.recurso.option},media:{get sources(){return _.where(b.ficha.recurso.sources,{type:"audio/mpeg"})}},get poster(){return _.findWhere(b.ficha.recurso.sources,{type:"image/jpeg"})}},get audioPregunta(){return _.findWhere(b.ficha.recurso.sources,{title:"pregunta"})}},b.parse={Url:function(a){return a.replace(" ","%20")},Char:function(a){return String.fromCharCode("a".charCodeAt()+a)}},b.buttons={Omitir:{get disable(){return null===b.ficha.respuesta},action:function(){b.ficha.respuesta=null,b.buttons.Siguiente.action()}},Anterior:{disable:!0,action:function(){b.ficha.current--}},Siguiente:{disable:!1,action:function(){void 0!==b.ficha.respuesta?b.ficha.current++:(i.pause(),j.src="src/audio/trabajador/EVA_ERROR.mp3",j.play(),g.info('Para poder continuar seleccione una alternativa, si no sabe la respuesta presione el botón naranja "No sé".',"Información"))}},Terminar:{disable:!0,action:function(){c.terminarEvaluacion().then(function(a){d.path("psicologicoPca")})}}},b.ficha.current=0}]),angular.module("trabajador").controller("configController",["$scope","toastr",function(a,b){localStorage&&localStorage.resource_endpoint&&(a.HostSrc=localStorage.resource_endpoint),a.saveHostingSrc=function(){a.HostSrc&&(localStorage.resource_endpoint=a.HostSrc,b.success("Se ha guardado el Host Alternativo","Exito"))},a.removeHostingSrc=function(){a.HostSrc&&(a.HostSrc="",localStorage.removeItem("resource_endpoint"),b.success("Se ha guardado el Host Alternativo","Exito"))},a.clearSession=function(){sessionStorage.clear(),b.success("Se han limpiado las credenciales","Exito")}}]),angular.module("trabajador").controller("trabajador.authController",["sessionServices","authenticationServices","$timeout","toastr","$scope",function(a,b,c,d,e){var f=function(){a.logout(),b.credential("qplan-evaluacion","0X7AR4Byme","true").then(function(b){a.token=b.data.access_token,a.refresh=b.data.refresh,a.expire_in=b.data.expire_in,d.success("Inicio del sistema.","Atención")},function(a){d.error("El sistema no se encuentra disponible en este momento","Atención")})},g=function(){a.expire?f():a.timeOut.getMinutes()<10&&(console.log("Necesita refrescar session"),b.renovate().then(function(b){console.log(b),a.refresh=b.data.refresh,a.expire_in=b.data.expire_in,d.success("Actualizando sistema.","Atención")},function(a){d.error("El sistema no se encuentra disponible en este momento","Atención")})),c(g,6e4)};c(g)}]),angular.module("trabajador").controller("antecendentesController",["$scope","$location","apiServices","trabajadorStorage","toastr","$filter",function(a,b,c,d,e,f){a.trabajador=d.q,console.log(a.trabajador);!function(a){var b=document.getElementById("player");b.src=a,b.play().then(function(){},function(c){b.src=a,b.play()})}(f("dinamicSource")("src/audio/trabajador/ANTECEDENTES.mp3"));var g=c.model("pais"),h=c.model("comuna"),i=c.model("trabajador"),j=c.model("ficha");j.params({tra_id:a.trabajador.id,ot_id:a.trabajador.ot.id}).search().then(function(b){a.trabajador.ficha=b.data[0],d.q=a.trabajador,console.log(d.q)},function(b){404==b.status&&j.save({tra_id:a.trabajador.id,ot_id:a.trabajador.ot.id,creacion:moment().format("YYYY-MM-DD HH:mm:ss"),proceso:"PENDIENTE"}).then(function(b){a.trabajador.ficha=b.data,d.q=a.trabajador,console.log(b)})}),a.Select={niveles:["Basica completa","Media incompleta","Media completa","Tecnica","Técnico en nivel superior incompleta","Técnico en nivel superior","Profesional incompleta","Profesional"],licencias:["A1","A2","A3","A4","A5","B","C","D","E","F"],estado_civil:["SOLTERO/A","CASADO/A","DIVORCIADO/A","SEPARADO","CONVIVIENTE"],tallas:["XXS","XS","S","M","L","XL","XXL","XXXL"],afp:["AFP Cuprum","AFP Habitat","AFP PlanVital","ProVida AFP","AFP Capital","AFP Modelo"],salud:["FONASA","BANMEDICA","CONSALUD","CRUZ BLANCA","ING","CAPREDENA","DIPRECA","MASVIDA","SIN PREVISIÓN"],sexo:["MASCULINO","FEMENINO"]},a.interface={set comuna(b){a.trabajador.comuna=b,angular.isObject(a.trabajador.comuna)&&(a.trabajador.com_id=a.trabajador.comuna.com_id)},get comuna(){return angular.isObject(a.trabajador.comuna)?a.trabajador.comuna.nombre:a.trabajador.comuna},set pais(b){a.trabajador.pais=b,angular.isObject(a.trabajador.pais)&&(a.trabajador.pais_id=a.trabajador.pais.id)},get pais(){return angular.isObject(a.trabajador.pais)?a.trabajador.pais.nombre:a.trabajador.pais}},a.trabajador.licencia&&(a.interface.licencia=a.trabajador.licencia.split(",")),a.getPaises=function(a){return g.params({nombre:a}).search().then(function(a){return a.data})},a.getComuna=function(a){return h.params({nombre:a}).search().then(function(a){return a.data})},a.siguiente=function(){a.trabajador.licencia&&(a.trabajador.licencia=a.interface.licencia.join(",")),i.save(a.trabajador).then(function(a){b.path("experiencia")},function(a){console.log(a),e.success("La información ingresada no esta completamente correcta.","Atentcion!")})}}]),angular.module("filters",["ApiRest"]),angular.module("filters").filter("dinamicSource",[function(){return function(a){return a=a||"",localStorage.resource_endpoint?localStorage.resource_endpoint+a:"/"+a}}]);