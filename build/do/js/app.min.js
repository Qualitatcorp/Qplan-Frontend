/*! qplan - v0.4.0 - 2017-06-29 - for Ruben Tejeda*/

"use strict";angular.module("ApiRest",[]).factory("WebApiConfig",function(){return{REST:{host:"/api",auth:"authentication",token:"token",refresh:"refresh",version:"v1",client_id:"do-evaluacion",client_secret:"alfabet497685"},get hostUrl(){return[this.REST.host,this.REST.version].join("/")},get authenticationUrl(){return[this.REST.host,this.REST.auth,this.REST.token].join("/")},get refreshUrl(){return[this.REST.host,this.REST.auth,this.REST.refresh].join("/")},resourceUrl:function(a){return[this.REST.host,this.REST.version,a].join("/")}}}),angular.module("ApiRest").factory("sessionServices",[function(){return{set token(a){console.log("Se almaceno token : "+a),sessionStorage.do_access_token=a},get token(){return console.log("Token valido por : "+this.timeOut.getMinutes()+" minutos"),this.expire?null:sessionStorage.do_access_token},set refresh(a){console.log("Se almaceno refresh : "+a),sessionStorage.do_access_refresh=a},get refresh(){return sessionStorage.do_access_refresh},set expire_in(a){console.log("La sesion dura : "+a/60+" minutos."),sessionStorage.do_expire_in=Date.now()+1e3*a},get expire(){return void 0===sessionStorage.do_expire_in||Date.now()>Number(sessionStorage.do_expire_in)},get timeOut(){return new Date(Number(sessionStorage.do_expire_in)-Date.now())},logout:function(){delete sessionStorage.do_access_token,delete sessionStorage.do_access_refresh,delete sessionStorage.do_expire_in,delete sessionStorage.do_cliend_id}}}]),angular.module("ApiRest").service("trabajadorStorage",[function(){return{set q(a){sessionStorage.setItem("trabajador",JSON.stringify(a))},get q(){return JSON.parse(sessionStorage.getItem("trabajador"))}}}]),angular.module("ApiRest").factory("evaluacionStorage",["apiServices",function(a){var b=a.model("ficha"),c=a.model("fichateorico"),d=a.model("ficharespuesta"),e={respuesta:[]},f={},g=[],h=[],i=function(a,b){g=[],a.ficteoricas&&a.ficteoricas.forEach(function(a){c.remove(a.id)}),b.forEach(function(b){c.save({mod_id:b.id,fic_id:a.id}).then(function(a){g.push(a.data)})})};return{nuevaEvaluacion:function(a,c){b.expand("ficteoricas").get(a.id).then(function(d){if(d.data.proceso){var e=d.data.proceso.split(",");e.push("EN PROGRESO TEORICO"),a.proceso=e.join(",")}else a.proceso=["EN PROGRESO TEORICO"];b.save(d.data).then(function(a){f=a.data,i(d.data,c)}),a={respuesta:[]}},function(b){a={respuesta:[]},console.warn("q")})},addRespuesta:function(a,b,c){var f=this.getRespuesta(a);f?(f.idAlternativa=b,f.idModulo=c,f.creado=moment().format("YYYY-MM-DD HH:mm:ss")):e.respuesta.push({idPregunta:a,idAlternativa:b,idModulo:c,creado:moment().format("YYYY-MM-DD HH:mm:ss")});var g=_.findWhere(h,{idPregunta:a});if(g)g.alt_id=b,d.save(g).then(function(a){});else{var i=this.getModulo(c);console.log(i),d.save({pre_id:a,fict_id:i.id,alt_id:b,creado:moment().format("YYYY-MM-DD HH:mm:ss")}).then(function(b){b.data.idPregunta=a,h.push(b.data)})}},getModulo:function(a){return _.findWhere(g,{mod_id:a})},getRespuesta:function(a){return _.findWhere(e.respuesta,{idPregunta:a})},eliminarEvaluacion:function(){e={respuesta:[]},f={},g=[],h=[],console.log("Evaluacion eliminada")},terminarEvaluacion:function(a){return f.proceso=a,b.save(f)},get count(){return e.respuesta.length}}}]),angular.module("ApiRest").service("authenticationServices",["WebApiConfig","$http","sessionServices",function(a,b,c){return{credential:function(c,d,e,f,g){var h={username:c,password:d,grant_type:g||"password",client_id:a.REST.client_id,client_secret:a.REST.client_secret,refresh:e||"false",identity:f||""};return b.post(a.authenticationUrl,h)},set identity(a){sessionStorage.setItem("identity",JSON.stringify(a.scope)),c.token=a.access_token},get identity(){sessionStorage.getItem("identity")},renovate:function(){if(c.refresh)return b.post(a.refreshUrl,{refresh:c.refresh});console.log("No se puede actualizar la session")}}}]),angular.module("ApiRest").service("apiServices",["WebApiConfig","$http","$httpParamSerializer","sessionServices",function(a,b,c,d){return{_base:null,_primaryKey:"id",_params:{},request:function(a){return _.compact([_.compact(a).join("/"),c(this._params)]).join("?")},get:function(c){return this.credential(),b.get(this.request([a.resourceUrl(this._base),c]))},getAll:function(){return this.get()},search:function(){return this.credential(),b.get(a.resourceUrl(this._base)+"/search?"+c(this._params))},save:function(c){return this.credential(),c[this._primaryKey]?b.put([a.resourceUrl(this._base),c[this._primaryKey]].join("/"),c):b.post(a.resourceUrl(this._base),c)},remove:function(c){return this.credential(),b.delete([a.resourceUrl(this._base),c].join("/"))},params:function(a){return this._params={},angular.extend(this._params,a),this},fields:function(a){return angular.extend(this._params,{fields:a}),this},expand:function(a){return this._params={},angular.extend(this._params,{expand:a}),this},sort:function(a){return angular.extend(this._params,{sort:a}),this},page:function(a){return angular.extend(this._params,{page:a}),this},perPage:function(a){return angular.extend(this._params,{"per-page":a}),this},model:function(a,b){return angular.extend(this,{_base:a,_primaryKey:b||this._primaryKey,_params:{}}),angular.copy(this)},credential:function(){d.expire?delete b.defaults.headers.common.Authorization:b.defaults.headers.common.Authorization="Bearer "+d.token}}}]),angular.module("filters",["ApiRest"]),angular.module("filters").filter("CIE",[function(){return function(a){var b=function(b,c,d){return[a.slice(0,d),a.slice(d)].join(c)};if(""!==(a=a||"")){if(!/^[0-9\-]+$/.test(a))return a=a.replace(/[^0-9\-]+/g,""),a.replace(/[^0-9\-]+/g,"");a.length>3&&(a=a.replace(new RegExp("-","g"),""),a=b(0,"-",3),a.length>11&&(a=b(0,"-",11)))}return a}}]),angular.module("filters").filter("dinamicSource",[function(){return function(a){return a=a||"",localStorage.resource_endpoint?localStorage.resource_endpoint+a:"/"+a}}]),angular.module("do",["ngRoute","ngAnimate","ngSanitize","ApiRest","toastr","filters"]).config(["$routeProvider",function(a){var b={basePath:"views/",to:function(a){return this.basePath+a+".html"}};a.when("/",{redirectTo:"/welcome"}).when("/welcome",{templateUrl:b.to("do/welcome")}).when("/register",{templateUrl:b.to("do/register"),controller:"do.registerCtrl"}).when("/evaluation",{templateUrl:b.to("do/evaluation"),controller:"do.evaluationCtrl",resolve:{perfil:["apiServices","PER_ID",function(a,b){return a.model("perfil").expand("modteorica,pet,evateorica,preguntas,alternativas,recursos,rhs,sources,rho,options").get(b)}]}}).when("/finished",{templateUrl:b.to("do/finished")}).when("/404",{template:"Error 404"}).otherwise({redirectTo:"/404"})}]).value("OT",2).value("PER_ID",5),angular.module("do").controller("do.evaluationCtrl",["$scope","$location","toastr","evaluacionStorage","trabajadorStorage","perfil",function(a,b,c,d,e,f){var f=f.data;console.log(f);var g={};g.perfil=f.nombre,g.preguntas=[];var h=f.preguntas;h.forEach(function(a){angular.extend(a,{alternativas:_.where(f.alternativas,{pre_id:a.id}),get recursos(){var b=_.findWhere(f.recursos,{pre_id:a.id});return angular.extend(b,{sources:_.map(_.where(f.rhs,{rec_id:b.id}),function(a){var b=_.findWhere(f.sources,{id:a.src_id});return b.tipo=a.tipo,b}),options:_.map(_.where(f.rho,{opt_id:b.id}),function(a){return _.findWhere(f.options,{id:a.src_id})})}),b},modulo:_.findWhere(f.modteorica,{id:_.findWhere(f.pet,{evt_id:_.findWhere(f.evateorica,{id:a.eva_id}).id}).mop_id})})}),d.nuevaEvaluacion(e.q,f.modteorica),a.evaluacion={perfil:f.nombre,preguntas:h},a.ficha={_current:0,get current(){return this._current},set current(b){b>=0&&b<this.preguntas.length&&(this._current=b,0==this._current?a.buttons.Anterior.disable=!0:(a.buttons.Anterior.disable=!1,this._current==this.preguntas.length-1?a.buttons.Siguiente.disable=!0:a.buttons.Siguiente.disable=!1))},get progreso(){return d.count/this.preguntas.length},get respuesta(){return d.getRespuesta(this.pregunta.id)?d.getRespuesta(this.pregunta.id).idAlternativa:void 0},set respuesta(b){d.addRespuesta(this.pregunta.id,b,this.pregunta.modulo.id),1==this.progreso&&(a.buttons.Terminar.disable=!1)},get preguntas(){return a.evaluacion.preguntas},get pregunta(){return this.preguntas[this.current]},get recurso(){return this.pregunta.recursos},get imagen(){var b=_.findWhere(a.ficha.recurso.sources,{tipo:"CONTENIDO"});if(b)return b;console.warn(a.ficha.recurso)}},a.parse={Url:function(a){if(a)return a.replace(" ","%20");console.warn("no existe url"+a)},Char:function(a){return String.fromCharCode("a".charCodeAt()+a)}},a.buttons={Omitir:{get disable(){return null===a.ficha.respuesta},action:function(){a.ficha.respuesta=null,a.buttons.Siguiente.action()}},Anterior:{disable:!0,action:function(){a.ficha.current--}},Siguiente:{disable:!1,action:function(){void 0!==a.ficha.respuesta?a.ficha.current++:(audio.pause(),error.src="src/audio/trabajador/EVA_ERROR.mp3",error.play(),c.info('Para poder continuar seleccione una alternativa, si no sabe la respuesta presione el botón naranja "No sé".',"Información"))}},Terminar:{disable:!0,action:function(){d.terminarEvaluacion("TERMINADO").then(function(a){e.q=null,d.eliminarEvaluacion(),b.path("/finished")})}}},a.ficha.current=0}]),angular.module("do").controller("do.registerCtrl",["$scope","$location","$filter","toastr","trabajadorStorage","apiServices","OT",function(a,b,c,d,e,f,g){var h=f.model("trabajador"),i=f.model("ficha"),j=f.model("ordentrabajotrabajador");a.model={pais_id:60},a.$watch("model.rut",function(){a.model.rut=c("CIE")(a.model.rut)});var k=function(a){j.params({ot_id:g,tra_id:a.id}).search().then(function(b){l(g,a.id)},function(b){j.save({ot_id:g,tra_id:a.id}).then(function(b){l(g,a.id)},function(b){l(g,a.id)})})},l=function(a,c){i.params({ot_id:a,tra_id:c}).search().then(function(a){e.q=a.data[0],b.path("/evaluation")},function(d){i.save({ot_id:a,tra_id:c,proceso:"PENDIENTE"}).then(function(a){e.q=a.data,b.path("/evaluation")},function(a){console.log(a)})})};a.find=function(){console.log(a.model.rut.length),a.model.rut.length>11&&h.params({rut:c("CIE")(a.model.rut)}).search().then(function(b){console.log(b.data[0]),b.data[0].nacimiento=new Date(b.data[0].nacimiento),a.model=b.data[0]})},a.clear=function(){a.model={pais_id:60}},a.register=function(){13==a.model.rut.length?(a.model.nacimiento&&(a.model.nacimiento=a.model.nacimiento.toISOString().split("T")[0]),h.save(a.model).then(function(a){k(a.data)},function(a){console.warn(a)})):d.warning("Ingrese su cedula de identidad y electoral.","¡Atención!")}}]),angular.module("do").controller("do.authCtrl",["$timeout","toastr","authenticationServices","sessionServices",function(a,b,c,d){var e=function(){d.logout(),c.credential("alfabetdigital","alfabet497685","true").then(function(a){d.token=a.data.access_token,d.refresh=a.data.refresh,d.expire_in=a.data.expire_in,b.success("Inicio del sistema.","Atención")},function(a){b.error("El sistema no se encuentra disponible en este momento","Atención")})},f=function(){d.expire?e():d.timeOut.getMinutes()<10&&(console.log("Necesita refrescar session"),c.renovate().then(function(a){console.log(a),d.refresh=a.data.refresh,d.expire_in=a.data.expire_in,b.success("Actualizando sistema.","Atención")},function(a){b.error("El sistema no se encuentra disponible en este momento","Atención")})),a(f,6e4)};a(f)}]);